<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Sādhana Bhārata — Devotional OS</title>
<meta name="theme-color" content="#6b4f2c">
<link rel="manifest" href="manifest.json" id="manifest-link">
<style>
  :root{
    --bg:#f4efe6; --brand:#6b4f2c; --card:#fff; --muted:#666;
    --accent:#8b6f47; --glass:rgba(0,0,0,0.04);
    font-size:16px;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#222}
  header{background:var(--brand);color:#fff;padding:18px 16px;text-align:center;font-weight:700;font-size:20px;position:sticky;top:0;z-index:20}
  .container{padding:14px;padding-bottom:120px;}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card);border-radius:14px;padding:12px;box-shadow:0 6px 18px var(--glass);flex:1 1 320px;min-width:260px}
  .title{font-size:18px;font-weight:700;margin:6px 0}
  .muted{color:var(--muted);font-size:14px}
  .big{font-size:20px}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-weight:600;font-size:16px;margin:6px 6px 0 0;touch-action:manipulation}
  .icon-btn{background:transparent;border:none;padding:8px;border-radius:8px}
  .search{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-top:8px}
  .list{margin-top:10px;max-height:290px;overflow:auto}
  .item{display:flex;align-items:center;padding:8px;border-radius:8px;margin-bottom:6px;cursor:pointer}
  .thumb{width:56px;height:56px;border-radius:8px;flex:0 0 56px;object-fit:cover;margin-right:10px;background:#eee}
  .meta{flex:1}
  .meta .h{font-weight:700}
  .meta .s{font-size:13px;color:var(--muted)}
  .small{font-size:13px;color:var(--muted)}
  .player{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,#fff, #f6f3ea);border-top:1px solid #e8e2d6;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow:0 -6px 20px rgba(0,0,0,0.06)}
  .player .controls{display:flex;align-items:center;gap:8px}
  .player .playbtn{width:52px;height:52px;border-radius:12px;border:none;background:var(--brand);color:#fff;font-size:18px}
  .progress{flex:1}
  .progress input[type="range"]{width:100%}
  .volume{width:120px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#efe6d9;font-size:13px;margin:4px 4px 0 0}
  .fav{color:crimson}
  .section-header{display:flex;justify-content:space-between;align-items:center}
  footer.small{font-size:12px;color:var(--muted);text-align:center;padding:10px 0}
  @media (max-width:700px){.row{flex-direction:column} .card{min-width:unset}}
</style>
</head>
<body>

<header>Sādhana Bhārata — Devotional Audio Library</header>

<div class="container">

  <div class="row">
    <div class="card" style="flex:1 1 360px;">
      <div class="section-header">
        <div>
          <div class="title">Player</div>
          <div class="muted">Single audio engine — only one track plays at a time</div>
        </div>
        <div>
          <button class="btn" id="unlockBtn">Unlock Audio</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Now Playing</div>
        <div id="nowPlaying" class="title">—</div>
        <div class="muted" id="nowMeta"></div>

        <div style="margin-top:12px" class="small">Queue</div>
        <div id="queueList" class="list"></div>

        <div style="margin-top:10px">
          <button class="btn" onclick="prevTrack()">Prev</button>
          <button class="btn" onclick="togglePlay()" id="playPauseBtn">Play</button>
          <button class="btn" onclick="nextTrack()">Next</button>
          <button class="btn" onclick="stopAudio()">Stop</button>
        </div>
      </div>
    </div>

    <div class="card" style="flex:1 1 420px;">
      <div class="title">Library — browse, search, add to queue</div>
      <input id="search" class="search" placeholder="Search titles, tags (e.g. om, bhaja, shankara)" oninput="renderLibrary()">

      <div style="margin-top:10px">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div class="pill" onclick="filterCategory('all')">All</div>
          <div class="pill" onclick="filterCategory('om')">OM</div>
          <div class="pill" onclick="filterCategory('bhajan')">Bhajans</div>
          <div class="pill" onclick="filterCategory('shankara')">Shankaracharya</div>
          <div class="pill" onclick="filterCategory('ambience')">Ambience</div>
          <div class="pill" onclick="filterCategory('stories')">Stories</div>
        </div>

        <div class="list" id="libraryList"></div>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:14px">
    <div class="card">
      <div class="title">Text Reader & Offline Cache</div>
      <div class="muted">Open a short excerpt, save for offline reading</div>

      <div style="margin-top:10px">
        <select id="textPicker" onchange="loadText()">
          <option value="">— Select excerpt —</option>
        </select>
      </div>
      <div style="margin-top:10px">
        <button class="btn" onclick="saveCurrentText()">Save Offline</button>
        <button class="btn" onclick="clearSavedTexts()">Clear Saved</button>
      </div>

      <div id="textArea" style="margin-top:12px;padding:12px;background:#faf7ee;border-radius:10px;min-height:120px"></div>

      <div style="margin-top:8px">
        <div class="small">Saved (offline) excerpts</div>
        <div id="savedList" class="list"></div>
      </div>
    </div>

    <div class="card">
      <div class="title">Favorites & Settings</div>
      <div class="muted">Tap ♥ to favorite a track. Favorites persist across sessions.</div>

      <div style="margin-top:10px">
        <div id="favorites" class="list"></div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Settings</div>
        <label class="small" style="display:block;margin-top:8px">
          <input type="checkbox" id="autoplay" /> Autoplay next track
        </label>
        <label class="small" style="display:block;margin-top:6px">
          <input type="checkbox" id="fade" checked /> Use gentle crossfade between tracks
        </label>
      </div>
    </div>
  </div>

  <footer class="small">Content sources: public-domain / free archives (Pixabay, Archive.org, Wikimedia, YouTube embeds). Use only free links.</footer>
</div>

<!-- single audio tag used for playback (we may swap src on queue change) -->
<audio id="player" crossorigin="anonymous"></audio>

<script>
/* ---------- Content library (intelligent curated free sources) ----------
   Each entry: id, title, artist, category, src (mp3/ogg), cover (thumb), duration (optional), textLink (optional)
   Note: All src links are to free / public resources or YouTube embeds handled separately.
---------------------------------------------------------------------*/
const LIBRARY = [
  /* OM variants */
  {id:'om_slow', title:'OM — Slow Chant', artist:'Solo (male)', category:'om',
   src:'https://cdn.pixabay.com/download/audio/2022/02/23/audio_7bff8fcdab.mp3?filename=om-chanting-10782.mp3',
   cover:'https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Om_symbol.svg/800px-Om_symbol.svg.png', textLink:''},
  {id:'om_deep', title:'OM — Deep Resonance', artist:'Deep Voice', category:'om',
   src:'https://cdn.pixabay.com/download/audio/2021/09/03/audio_d7fd4db13b.mp3?filename=om-chant-6071.mp3',
   cover:'https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Om_symbol.svg/800px-Om_symbol.svg.png', textLink:''},
  {id:'om_group', title:'OM — Group Chant', artist:'Chorus', category:'om',
   src:'https://cdn.pixabay.com/download/audio/2022/10/25/audio_c7b0d8df31.mp3?filename=om-chant-group-124693.mp3',
   cover:'https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Om_symbol.svg/800px-Om_symbol.svg.png', textLink:''},

  /* Shankaracharya / Bhaja Govindam etc (public/free recordings) */
  {id:'bhaja_govindam', title:'Bhaja Govindam (Devotional Bhajan)', artist:'Public Recording', category:'shankara',
   src:'https://cdn.pixabay.com/download/audio/2022/10/19/audio_3dc4d90b18.mp3?filename=bhajan-124290.mp3',
   cover:'https://upload.wikimedia.org/wikipedia/commons/thumb/3/37/Adi_Shankara.jpg/330px-Adi_Shankara.jpg', textLink:'https://www.sacred-texts.com/hin/sha.htm'},
  {id:'nirvana_shatakam', title:'Nirvana Shatakam (chant)', artist:'Public Recording', category:'shankara',
   src:'https://cdn.pixabay.com/download/audio/2023/01/17/audio_4f6a6fdd45.mp3?filename=chant-137841.mp3',
   cover:'https://upload.wikimedia.org/wikipedia/commons/thumb/3/37/Adi_Shankara.jpg/330px-Adi_Shankara.jpg', textLink:'https://sanskritdocuments.org/doc_shankara/nirvana_shatakam.pdf'},

  /* Saundarya Lahari / related */
  {id:'saundarya', title:'Saundarya Lahari — Excerpt', artist:'Public', category:'shankara',
   src:'https://cdn.pixabay.com/download/audio/2022/03/22/audio_08a5f84c5c.mp3?filename=indian-chant-112191.mp3',
   cover:'https://upload.wikimedia.org/wikipedia/commons/thumb/3/37/Adi_Shankara.jpg/330px-Adi_Shankara.jpg', textLink:''},

  /* Bhajans & devotional */
  {id:'bhajan1', title:'Krishna Bhajan — Bhaja Govindam style', artist:'Public', category:'bhajan',
   src:'https://cdn.pixabay.com/download/audio/2022/10/19/audio_3dc4d90b18.mp3?filename=bhajan-124290.mp3',
   cover:'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Krishna_with_flute.jpg/320px-Krishna_with_flute.jpg', textLink:''},

  /* Ambience & temple */
  {id:'temple_bell', title:'Temple Bell (single)', artist:'Ambience', category:'ambience',
   src:'https://cdn.pixabay.com/download/audio/2021/08/04/audio_8848bb1e64.mp3?filename=temple-bell-6174.mp3',
   cover:'https://upload.wikimedia.org/wikipedia/commons/thumb/6/68/Temple_bell.jpg/320px-Temple_bell.jpg', textLink:''},
  {id:'temple_chant', title:'Temple Chant Ambience', artist:'Ambience', category:'ambience',
   src:'https://cdn.pixabay.com/download/audio/2022/02/01/audio_6d70aefb33.mp3?filename=temple-ambience-102474.mp3',
   cover:'https://upload.wikimedia.org/wikipedia/commons/thumb/6/68/Temple_bell.jpg/320px-Temple_bell.jpg', textLink:''},

  /* Stories (link-only, open external) */
  {id:'ramayana_story', title:'Ramayana — Excerpt (read)', artist:'Text', category:'stories',
   src:'', cover:'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/Ramayana.jpg/320px-Ramayana.jpg',
   textLink:'https://www.sacred-texts.com/hin/rama/'},
  {id:'mahabharata_story', title:'Mahabharata — Excerpt (read)', artist:'Text', category:'stories',
   src:'', cover:'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/Mahabharata.jpg/320px-Mahabharata.jpg',
   textLink:'https://www.sacred-texts.com/hin/maha/'}
];

/* ---------- app state & persistence ---------- */
let state = {
  queue: [],           // array of library ids
  index: 0,            // current index in queue
  favorites: JSON.parse(localStorage.getItem('sb_fav')||'{}'),
  savedTexts: JSON.parse(localStorage.getItem('sb_texts')||'{}'),
  autoplay: JSON.parse(localStorage.getItem('sb_autoplay')||'true'),
  useFade: JSON.parse(localStorage.getItem('sb_fade')||'true'),
  unlocked: false
};

const player = document.getElementById('player');
const queueListEl = document.getElementById('queueList');
const libraryEl = document.getElementById('libraryList');
const nowPlayingEl = document.getElementById('nowPlaying');
const nowMetaEl = document.getElementById('nowMeta');
const favEl = document.getElementById('favorites');
const savedListEl = document.getElementById('savedList');
const searchEl = document.getElementById('search');
const unlockBtn = document.getElementById('unlockBtn');
const playPauseBtn = document.getElementById('playPauseBtn');

document.getElementById('autoplay').checked = (state.autoplay === true);
document.getElementById('fade').checked = (state.useFade === true);

/* populate text picker and saved list */
const TEXT_EXCERPTS = {
  "Gita-Intro": {title:"Bhagavad Gita — Intro (excerpt)", source:"Public domain translations", text:
`The Supreme Self is beyond grief; one who is devoted attains peace. - Gita (excerpt)`},
  "Ramayana-Intro": {title:"Ramayana — Excerpt", source:"Valmiki (public domain)", text:
`Rama's exile teaches righteous endurance and adherence to Dharma.`}
};

/* initialise UI */
function init(){
  renderLibrary();
  renderQueue();
  renderFavorites();
  renderSavedTexts();
  populateTextPicker();
  bindEvents();
  restoreSettings();
}

/* render library with search + filter */
let activeCategory = 'all';
function filterCategory(cat){
  activeCategory = cat;
  renderLibrary();
}
function renderLibrary(){
  const q = (searchEl.value||'').toLowerCase().trim();
  libraryEl.innerHTML = '';
  const filtered = LIBRARY.filter(item=>{
    if(activeCategory !== 'all' && item.category !== activeCategory) return false;
    if(q === '') return true;
    return (item.title||'').toLowerCase().includes(q) || (item.artist||'').toLowerCase().includes(q) || (item.category||'').toLowerCase().includes(q);
  });
  filtered.forEach(item=>{
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `
      <img class="thumb" src="${item.cover}" alt="">
      <div class="meta">
        <div class="h">${escapeHtml(item.title)} <span style="float:right"><button class="icon-btn" title="fav" onclick="toggleFav(event,'${item.id}')">${state.favorites[item.id]? '♥':'♡'}</button></span></div>
        <div class="s">${escapeHtml(item.artist)} • ${escapeHtml(item.category)}</div>
      </div>
      <div style="margin-left:8px">
        <button class="btn" onclick="addToQueue('${item.id}')">Queue</button>
      </div>
    `;
    el.onclick = (ev)=>{
      if(ev.target.tagName.toLowerCase() === 'button' || ev.target.tagName.toLowerCase()==='img') return;
      previewItem(item.id);
    };
    libraryEl.appendChild(el);
  });
}

/* add to queue */
function addToQueue(id, playImmediately=false){
  state.queue.push(id);
  renderQueue();
  if(playImmediately){
    state.index = state.queue.length - 1;
    loadQueueIndex(state.index);
  }
  saveState();
}

/* render queue */
function renderQueue(){
  queueListEl.innerHTML = '';
  state.queue.forEach((id, i)=>{
    const it = LIBRARY.find(x=>x.id===id) || {title:id};
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML = `
      <div style="flex:1"><b>${escapeHtml(it.title)}</b><div class="small">${escapeHtml(it.artist || '')}</div></div>
      <div>
        <button class="btn" onclick="playQueueIndex(event,${i})">Play</button>
        <button class="btn" onclick="removeQueueItem(event,${i})">Remove</button>
      </div>
    `;
    queueListEl.appendChild(div);
  });
}

/* play specific queue index */
function playQueueIndex(ev, idx){
  ev.stopPropagation();
  state.index = idx;
  loadQueueIndex(idx);
}

/* remove queue item */
function removeQueueItem(ev, idx){
  ev.stopPropagation();
  state.queue.splice(idx,1);
  if(state.index >= state.queue.length) state.index = Math.max(0, state.queue.length - 1);
  renderQueue();
  saveState();
}

/* load & play at queue index */
let fadeTimer = null;
function loadQueueIndex(idx){
  if(!state.queue[idx]){ stopAudio(); return; }
  const item = LIBRARY.find(x=>x.id===state.queue[idx]);
  if(!item){ stopAudio(); return; }
  setNowPlaying(item);
  // fade out if enabled
  if(state.useFade){
    fadeOut(300, ()=>{ setPlayerSrcAndPlay(item.src); });
  } else {
    setPlayerSrcAndPlay(item.src);
  }
}

/* set src and start */
function setPlayerSrcAndPlay(src){
  if(!src){ stopAudio(); return; }
  try{
    player.src = src;
  }catch(e){
    console.warn('player src set error',e);
    alert('Cannot play this source.');
    return;
  }
  const p = player.play();
  if(p && p.catch) p.catch(err=>{
    console.warn('play failed',err);
    // play likely blocked — require user gesture — provide visual hint
    alert('Audio requires a tap to unlock. Press "Unlock Audio" button.');
  });
  updatePlayPauseBtn();
}

/* preview (open details modal — here we'll set Now Playing preview without adding to queue) */
function previewItem(id){
  const it = LIBRARY.find(x=>x.id===id);
  if(!it) return;
  document.getElementById('nowPlaying').innerText = it.title;
  nowMetaEl.innerText = `${it.artist || ''} • ${it.category}`;
}

/* next/prev/stop */
function nextTrack(){
  if(state.index + 1 < state.queue.length){
    state.index++;
    loadQueueIndex(state.index);
    renderQueue();
    saveState();
  } else {
    // nothing in queue; stop
    stopAudio();
  }
}
function prevTrack(){
  if(state.index - 1 >= 0){
    state.index--;
    loadQueueIndex(state.index);
    renderQueue();
    saveState();
  }
}
function stopAudio(){
  if(player){
    if(state.useFade){
      fadeOut(300, ()=>{ player.pause(); player.currentTime = 0; updatePlayPauseBtn(); });
    } else {
      player.pause();
      player.currentTime = 0;
      updatePlayPauseBtn();
    }
  }
  currentAudio = null;
  nowPlayingEl.innerText = '—';
  nowMetaEl.innerText = '';
}

/* play/pause toggle */
function togglePlay(){
  if(player.paused && player.src){
    player.play().catch(e=>{ alert('Tap Unlock Audio first.'); });
  } else {
    player.pause();
  }
  updatePlayPauseBtn();
}
function updatePlayPauseBtn(){
  playPauseBtn.innerText = player.paused ? 'Play' : 'Pause';
}

/* favorites */
function toggleFav(ev, id){
  ev && ev.stopPropagation();
  if(state.favorites[id]){
    delete state.favorites[id];
  } else {
    state.favorites[id] = true;
  }
  saveState();
  renderFavorites();
  renderLibrary();
}
function renderFavorites(){
  favEl.innerHTML = '';
  const favIds = Object.keys(state.favorites);
  if(favIds.length === 0){
    favEl.innerHTML = '<div class="small muted">No favorites yet. Tap ♥ on a track.</div>';
    return;
  }
  favIds.forEach(id=>{
    const it = LIBRARY.find(x=>x.id===id);
    const d = document.createElement('div'); d.className='item';
    d.innerHTML = `<img class="thumb" src="${it.cover}"><div class="meta"><div class="h">${escapeHtml(it.title)}</div><div class="s">${escapeHtml(it.artist)}</div></div><div><button class="btn" onclick="addToQueue('${it.id}', true)">Play</button></div>`;
    favEl.appendChild(d);
  });
}

/* saved text offline */
function populateTextPicker(){
  const sel = document.getElementById('textPicker');
  Object.keys(TEXT_EXCERPTS).forEach(k=>{
    const opt = document.createElement('option');
    opt.value = k; opt.text = TEXT_EXCERPTS[k].title;
    sel.appendChild(opt);
  });
}
function loadText(){
  const id = document.getElementById('textPicker').value;
  if(!id) return;
  const txt = TEXT_EXCERPTS[id];
  document.getElementById('textArea').innerHTML = `<h4>${escapeHtml(txt.title)}</h4><p style="white-space:pre-wrap">${escapeHtml(txt.text)}</p><div class="small">Source: ${escapeHtml(txt.source)}</div>`;
}
function saveCurrentText(){
  const sel = document.getElementById('textPicker').value;
  if(!sel) { alert('Select an excerpt first'); return; }
  state.savedTexts[sel] = TEXT_EXCERPTS[sel];
  localStorage.setItem('sb_texts', JSON.stringify(state.savedTexts));
  renderSavedTexts();
}
function renderSavedTexts(){
  savedListEl.innerHTML = '';
  const keys = Object.keys(state.savedTexts||{});
  if(keys.length === 0){ savedListEl.innerHTML = '<div class="small muted">No saved excerpts.</div>'; return; }
  keys.forEach(k=>{
    const it = state.savedTexts[k];
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div style="flex:1"><b>${escapeHtml(it.title)}</b><div class="small">${escapeHtml(it.source)}</div></div><div><button class="btn" onclick="openSavedText('${k}')">Open</button><button class="btn" onclick="deleteSavedText('${k}')">Delete</button></div>`;
    savedListEl.appendChild(div);
  });
}
function openSavedText(k){
  document.getElementById('textArea').innerHTML = `<h4>${escapeHtml(state.savedTexts[k].title)}</h4><p style="white-space:pre-wrap">${escapeHtml(state.savedTexts[k].text)}</p>`;
}
function deleteSavedText(k){
  delete state.savedTexts[k];
  localStorage.setItem('sb_texts', JSON.stringify(state.savedTexts));
  renderSavedTexts();
}
function clearSavedTexts(){
  if(!confirm('Clear all saved excerpts?')) return;
  state.savedTexts = {};
  localStorage.setItem('sb_texts','{}');
  renderSavedTexts();
}

/* unlock audio (user gesture) */
unlockBtn.addEventListener('click', ()=>{
  // unlock by creating/resuming audio context via play/pause trick
  player.volume = 0.0001;
  player.play().then(()=>{ player.pause(); player.currentTime = 0; player.volume = 1.0; state.unlocked = true; unlockBtn.innerText = 'Audio Unlocked'; }).catch(e=>{
    alert('Tap any Play button (Play) on screen to unlock audio for Safari.');
  });
});

/* player event handlers */
player.addEventListener('ended', ()=>{
  if(state.autoplay && state.index + 1 < state.queue.length){
    state.index++;
    loadQueueIndex(state.index);
    renderQueue();
  } else {
    updatePlayPauseBtn();
  }
});
player.addEventListener('play', updatePlayPauseBtn);
player.addEventListener('pause', updatePlayPauseBtn);

/* set now playing UI */
function setNowPlaying(item){
  nowPlayingEl.innerText = item.title;
  nowMetaEl.innerText = `${item.artist || ''} • ${item.category}`;
}

/* preview / small-play helpers */
function playAudio(id){
  const item = LIBRARY.find(x=>x.id===id);
  if(!item) return;
  // replace queue with this single item for immediate play
  state.queue = [id];
  state.index = 0;
  renderQueue();
  loadQueueIndex(0);
  saveState();
}

/* fade helpers */
function fadeOut(ms, cb){
  if(!player) { cb && cb(); return; }
  const steps = 12;
  const step = ms/steps;
  let cur = player.volume;
  let i=0;
  const t = setInterval(()=>{
    i++;
    const vol = Math.max(0, cur*(1 - i/steps));
    player.volume = vol;
    if(i>=steps){
      clearInterval(t);
      player.volume = cur; // restore default (will be set below when playing new)
      cb && cb();
    }
  }, step);
}

/* helper util: escape html */
function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* save state */
function saveState(){ localStorage.setItem('sb_fav', JSON.stringify(state.favorites)); localStorage.setItem('sb_queue', JSON.stringify(state.queue)); localStorage.setItem('sb_index', state.index.toString()); localStorage.setItem('sb_autoplay', JSON.stringify(state.autoplay)); localStorage.setItem('sb_fade', JSON.stringify(state.useFade)); }

/* restore settings */
function restoreSettings(){
  // restore queue if present
  try{
    const q = JSON.parse(localStorage.getItem('sb_queue')||'null');
    if(Array.isArray(q) && q.length>0){ state.queue = q; state.index = parseInt(localStorage.getItem('sb_index')||'0'); }
  }catch(e){}
  // favorites already loaded
  renderQueue(); renderFavorites(); renderSavedTexts();
}

/* remove queue item helper (used in renderQueue) */
window.removeQueueItem = removeQueueItem;
window.addToQueue = (id,playNow)=>{ state.queue.push(id); renderQueue(); if(playNow){ state.index = state.queue.length-1; loadQueueIndex(state.index); } saveState(); };
window.playQueueIndex = playQueueIndex;
window.playAudio = playAudio;
window.prevTrack = prevTrack;
window.nextTrack = nextTrack;
window.stopAudio = stopAudio;
window.togglePlay = togglePlay;
window.setVolume = (v)=>{ setVolume(Number(v)); };
window.filterCategory = filterCategory;
window.toggleFav = toggleFav;
window.saveCurrentText = saveCurrentText;
window.clearSavedTexts = clearSavedTexts;

/* init DOM after load */
document.addEventListener('DOMContentLoaded', ()=>{ init(); });

/* optional: register minimal service worker if manifest exists (for PWA) */
if('serviceWorker' in navigator){
  try{
    navigator.serviceWorker.register('sw.js').catch(()=>{ /* ignore if not present */ });
  }catch(e){}
}
</script>

</body>
</html>
